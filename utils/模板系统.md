## 模板系统

### HTML字符逃逸

underscore中提供了`_.escape(string)`及`_.unescape(string)`来对HTML字符串进行逃逸/反逃逸，他们都由内部函数`createEscaper(map)`进行创建：

```js
// 定义一系列需要逃逸的html字符
var escapeMap = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '`': '&#x60;'
};


// 反逃逸Map
var unescapeMap = _.invert(escapeMap);

/**
 * 转义html特殊字符
 * @param {string} string 待转义字符
 */
_.escape = createEscaper(escapeMap);

/**
 * 取消转义
 * @param {string} string 待取消转义字符
 */
_.unescape = createEscaper(unescapeMap);
```

其源码如下：

```js
var createEscaper = function (map) {
    var escaper = function (match) {
        // 每次捕获通过map中创建的映射进行替换
        return map[match];
    };
    // Regexes for identifying a key that needs to be escaped.
    // 动态创建正则表达式，不捕获
    var source = '(?:' + _.keys(map).join('|') + ')';
    // 测试正则与替换正则
    var testRegexp = RegExp(source);
    var replaceRegexp = RegExp(source, 'g');

    return function (string) {
        string = string == null ? '' : '' + string;
        return testRegexp.test(string) ? string.replace(replaceRegexp, escaper) : string;
    };
};
```